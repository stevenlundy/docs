import Guide from '~/components/layout/guide'
import { TerminalInput } from '~/components/text/terminal'
import { InlineCode } from '~/components/text/code'
import Caption from '~/components/text/caption'
import Note from '~/components/text/note'
import { GenericLink } from '~/components/text/link'
import Card from '~/components/card'

export const meta = {
  title: 'Create a Dialogflow Fulfillment and Deploy with Now',
  description: 'Creating a Dialogflow Fulfillment project and deploying it with ZEIT Now',
  published: '2019-03-07T12:00:00.860Z',
  authors: ['stevenlundy'],
  url: '/guides/dialogflow-fulfillment-with-now'
}

[Dialogflow](https://dialogflow.com/) is a framework for humanâ€“computer interaction technologies based on natural language conversations.

## Step 1: Set Up Your Dialogflow Project

The first step to [setting up a Dialogflow project](https://dialogflow.com/docs/tutorial-build-an-agent) is to create a project directory and then install the required dependencies from your terminal:

<TerminalInput>npm --install dialogflow dialogflow-fulfillment express body-parser</TerminalInput>
<Caption>Installing dialogflow, express, and body-parser with npm.</Caption>

## Step 2: Deploy Your Dialogflow Project with Now

With your Dialogflow project set up, you are ready to deploy your app with [Now](/now).

If you have not yet installed Now, you can do so by installing the [Now Desktop app](/docs/v2/getting-started/installation/#now-desktop) which installs Now CLI automatically, or by [installing Now CLI](/docs/v2/getting-started/installation/#now-cli) directly.

Next, go ahead and create an `index.js` file at the root of the project directory with the following code as its contents:

```js
const express = require('express')
const bodyParser = require('body-parser')
const app = express()
app.use(bodyParser.json())

const {WebhookClient} = require('dialogflow-fulfillment');
const {Card, Suggestion} = require('dialogflow-fulfillment');


app.post('*', function(request, response) {
  const agent = new WebhookClient({ request, response });

  function welcome (agent) {
    agent.add("Welcome to my agent deployed on NOW!"");
  }

  let intentMap = new Map();
  intentMap.set('Default Welcome Intent', welcome);
  agent.handleRequest(intentMap);
});

module.exports = app;
```

<Caption>
  A basic Dialogflow Fullfillment script.
</Caption>

Next, you will need to tell Now what the entrypoint is for the application and what [Builder](/docs/v2/deployments/builders/overview/) it should use to build and deploy the application.

You will need to create a [`now.json` configuration file](/docs/v2/deployments/configuration) to instruct Now on building your application and serving it to visitors, this is where you specify the [Builder](/docs/v2/deployments/builders/overview/) and entrypoint mentioned above.

```json
{
  "version": 2,
  "name": "Dialogflow Fulfillment",
  "builds": [{ "src": "index.js", "use": "@now/node" }],
  "routes": [{ "src": "/.*", "dest": "index.js" }]
}
```

<Caption>
  A <InlineCode>now.json</InlineCode> configuration file that specifies the
  [Node Builder](/docs/v2/deployments/official-builders/node-js-now-node/).
</Caption>

The above `now.json` file achieves a few things:

- Defines a `version` property to ensure you are using the latest [Now 2.0 platform](/docs/v2/platform/overview) version.
- Defines a project `name` that your deployments will be sorted under and known by under Now.
- Defines a [`builds` property](/docs/v2/deployments/builds/) as an array with one build step using `@now/node` to instruct Now to statically build the project and deploy the `build` directory.
- Defines a [`routes` property](/docs/v2/deployments/routes/) as an array with one route directing all requests to use the `index.js` file that we defined above.

<Note>
  Don't forget to exclude the <InlineCode>node_modules</InlineCode> folder from
  being uploaded to Now to enable faster deployment. To do so, add a{' '}
  <GenericLink href="/guides/prevent-uploading-sourcepaths-with-nowignore/">
    .nowignore
  </GenericLink>{' '}
  file to the root of the project directory and add{' '}
  <InlineCode>node_modules</InlineCode> to it.
</Note>

### Deploying with Now

You are now ready to deploy the app with Now:

<TerminalInput>now</TerminalInput>
<Caption>Deploying your Dialogflow Fulfillment app with the Now CLI from a terminal.</Caption>

Once the app is deployed, you will receive a deployment URL similar to the following (styled for effect, with an additional page): https://dialogflowfulfillment-ep0m16tus.now.sh

### Connecting your Dialogflow Fulfillment webhook to an agent

Now that you have your Dialogflow Fullfillment server running, you can connect it to an agent and start fulling requests based on their intent.

 1. [Create and customize and agent](https://dialogflow.com/docs/tutorial-build-an-agent/create-customize-agent).
 2. [Provide your deployment URL for the webhook](https://dialogflow.com/docs/fulfillment/configure)

Your agent will now respond to the [Default Welcome Intent](https://dialogflow.com/docs/intents/default-intents) using your deployed webhook.

## Resources

For more information on working with Dialogflow, please refer to [the Dialogflow documentation](https://dialogflow.com/docs).

To configure Now further, please see these additional topics and guides:

<Card title="Deploying Basics" href="/docs/v2/deployments/basics">
  Deploy any of your applications with ZEIT Now.
</Card>

<Card
  title="Aliasing"
  href="/docs/v2/domains-and-aliases/aliasing-a-deployment/"
>
  Learn more about aliasing to your deployments.
</Card>

<Card title="More Guides" href="/guides">
  See more guides that help you move forward with your projects and deployments.
</Card>

export default ({ children }) => <Guide meta={meta}>{children}</Guide>
